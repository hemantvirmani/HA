# SINGLE OVERALL AQI SENSOR ONLY
# Add this to your configuration.yaml

template:
  - sensor:
      - name: "Air Quality Index"
        unique_id: air_quality_index_overall
        unit_of_measurement: "AQI"
        state_class: measurement
        icon: mdi:air-filter
        state: >-
          {% set aqi_list = [] %}
          
          {# PM2.5 AQI #}
          {% set pm25 = states('sensor.openweathermap_pm2_5') | float(-1) %}
          {% if pm25 >= 0 %}
            {% if pm25 <= 12.0 %}{% set pm25_aqi = (50 * pm25 / 12.0) | round(0) %}
            {% elif pm25 <= 35.4 %}{% set pm25_aqi = (51 + (100-51) * (pm25-12.1) / (35.4-12.1)) | round(0) %}
            {% elif pm25 <= 55.4 %}{% set pm25_aqi = (101 + (150-101) * (pm25-35.5) / (55.4-35.5)) | round(0) %}
            {% elif pm25 <= 150.4 %}{% set pm25_aqi = (151 + (200-151) * (pm25-55.5) / (150.4-55.5)) | round(0) %}
            {% elif pm25 <= 250.4 %}{% set pm25_aqi = (201 + (300-201) * (pm25-150.5) / (250.4-150.5)) | round(0) %}
            {% else %}{% set pm25_aqi = (301 + (500-301) * (pm25-250.5) / (500.4-250.5)) | round(0) %}
            {% endif %}
            {% set aqi_list = aqi_list + [pm25_aqi] %}
          {% endif %}
          
          {# PM10 AQI #}
          {% set pm10 = states('sensor.airnow_pm10') | float(-1) %}
          {% if pm10 >= 0 %}
            {% if pm10 <= 54 %}{% set pm10_aqi = (50 * pm10 / 54) | round(0) %}
            {% elif pm10 <= 154 %}{% set pm10_aqi = (51 + (100-51) * (pm10-55) / (154-55)) | round(0) %}
            {% elif pm10 <= 254 %}{% set pm10_aqi = (101 + (150-101) * (pm10-155) / (254-155)) | round(0) %}
            {% elif pm10 <= 354 %}{% set pm10_aqi = (151 + (200-151) * (pm10-255) / (354-255)) | round(0) %}
            {% elif pm10 <= 424 %}{% set pm10_aqi = (201 + (300-201) * (pm10-355) / (424-355)) | round(0) %}
            {% else %}{% set pm10_aqi = (301 + (500-301) * (pm10-425) / (604-425)) | round(0) %}
            {% endif %}
            {% set aqi_list = aqi_list + [pm10_aqi] %}
          {% endif %}
          
          {# CO AQI - convert μg/m³ to ppm #}
          {% set co_ugm3 = states('sensor.openweathermap_carbon_monoxide') | float(-1) %}
          {% if co_ugm3 >= 0 %}
            {% set co = (co_ugm3 * 0.000873) | round(1) %}
            {% if co <= 4.4 %}{% set co_aqi = (50 * co / 4.4) | round(0) %}
            {% elif co <= 9.4 %}{% set co_aqi = (51 + (100-51) * (co-4.5) / (9.4-4.5)) | round(0) %}
            {% elif co <= 12.4 %}{% set co_aqi = (101 + (150-101) * (co-9.5) / (12.4-9.5)) | round(0) %}
            {% elif co <= 15.4 %}{% set co_aqi = (151 + (200-151) * (co-12.5) / (15.4-12.5)) | round(0) %}
            {% elif co <= 30.4 %}{% set co_aqi = (201 + (300-201) * (co-15.5) / (30.4-15.5)) | round(0) %}
            {% else %}{% set co_aqi = (301 + (500-301) * (co-30.5) / (50.4-30.5)) | round(0) %}
            {% endif %}
            {% set aqi_list = aqi_list + [co_aqi] %}
          {% endif %}
          
          {# SO2 AQI - convert μg/m³ to ppb #}
          {% set so2_ugm3 = states('sensor.openweathermap_sulphur_dioxide') | float(-1) %}
          {% if so2_ugm3 >= 0 %}
            {% set so2 = (so2_ugm3 * 0.382) | round(0) %}
            {% if so2 <= 35 %}{% set so2_aqi = (50 * so2 / 35) | round(0) %}
            {% elif so2 <= 75 %}{% set so2_aqi = (51 + (100-51) * (so2-36) / (75-36)) | round(0) %}
            {% elif so2 <= 185 %}{% set so2_aqi = (101 + (150-101) * (so2-76) / (185-76)) | round(0) %}
            {% elif so2 <= 304 %}{% set so2_aqi = (151 + (200-151) * (so2-186) / (304-186)) | round(0) %}
            {% elif so2 <= 604 %}{% set so2_aqi = (201 + (300-201) * (so2-305) / (604-305)) | round(0) %}
            {% else %}{% set so2_aqi = (301 + (500-301) * (so2-605) / (1004-605)) | round(0) %}
            {% endif %}
            {% set aqi_list = aqi_list + [so2_aqi] %}
          {% endif %}
          
          {# O3 AQI - convert μg/m³ to ppm #}
          {% set o3_ugm3 = states('sensor.openweathermap_ozone') | float(-1) %}
          {% if o3_ugm3 >= 0 %}
            {% set o3 = (o3_ugm3 * 0.000509) | round(3) %}
            {% if o3 <= 0.054 %}{% set o3_aqi = (50 * o3 / 0.054) | round(0) %}
            {% elif o3 <= 0.070 %}{% set o3_aqi = (51 + (100-51) * (o3-0.055) / (0.070-0.055)) | round(0) %}
            {% elif o3 <= 0.085 %}{% set o3_aqi = (101 + (150-101) * (o3-0.071) / (0.085-0.071)) | round(0) %}
            {% elif o3 <= 0.105 %}{% set o3_aqi = (151 + (200-151) * (o3-0.086) / (0.105-0.086)) | round(0) %}
            {% elif o3 <= 0.200 %}{% set o3_aqi = (201 + (300-201) * (o3-0.106) / (0.200-0.106)) | round(0) %}
            {% else %}{% set o3_aqi = (301 + (500-301) * (o3-0.201) / (0.604-0.201)) | round(0) %}
            {% endif %}
            {% set aqi_list = aqi_list + [o3_aqi] %}
          {% endif %}
          
          {# Return max AQI #}
          {% if aqi_list | length > 0 %}{{ aqi_list | max }}{% else %}0{% endif %}
        attributes:
          category: >-
            {% set aqi = states('sensor.air_quality_index') | float(0) %}
            {% if aqi <= 50 %}Good
            {% elif aqi <= 100 %}Moderate
            {% elif aqi <= 150 %}Unhealthy for Sensitive Groups
            {% elif aqi <= 200 %}Unhealthy
            {% elif aqi <= 300 %}Very Unhealthy
            {% else %}Hazardous
            {% endif %}
          color: >-
            {% set aqi = states('sensor.air_quality_index') | float(0) %}
            {% if aqi <= 50 %}Green
            {% elif aqi <= 100 %}Yellow
            {% elif aqi <= 150 %}Orange
            {% elif aqi <= 200 %}Red
            {% elif aqi <= 300 %}Purple
            {% else %}Maroon
            {% endif %}